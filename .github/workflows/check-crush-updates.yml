name: Check Crush Updates

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-crush-updates:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest Crush version from npm
        id: latest-version
        run: |
          LATEST_VERSION=$(npm view @charmland/crush version)
          echo "version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "Latest @charmland/crush version: $LATEST_VERSION"

      - name: Parse current CRUSH_VERSION from script
        id: current-version
        run: |
          CURRENT_VERSION=$(grep '^CRUSH_VERSION=' docker-sandbox-crush | cut -d'"' -f2)
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current Crush version: $CURRENT_VERSION"

      - name: Compare versions
        id: compare-versions
        run: |
          CURRENT="${{ steps.current-version.outputs.version }}"
          LATEST="${{ steps.latest-version.outputs.version }}"

          echo "Comparing: $CURRENT vs $LATEST"

          # Parse version numbers
          IFS='.' read -r CURRENT_MAJOR CURRENT_MINOR CURRENT_PATCH <<< "$CURRENT"
          IFS='.' read -r LATEST_MAJOR LATEST_MINOR LATEST_PATCH <<< "$LATEST"

          # Remove 'v' prefix if present
          CURRENT_MAJOR="${CURRENT_MAJOR#v}"
          LATEST_MAJOR="${LATEST_MAJOR#v}"

          echo "Current: $CURRENT_MAJOR.$CURRENT_MINOR.$CURRENT_PATCH"
          echo "Latest: $LATEST_MAJOR.$LATEST_MINOR.$LATEST_PATCH"

          # Compare versions
          if [ "$CURRENT_MAJOR" -gt "$LATEST_MAJOR" ] 2>/dev/null; then
            echo "update_needed=false" >> $GITHUB_OUTPUT
            echo "Current version is newer (major)"
          elif [ "$CURRENT_MAJOR" -lt "$LATEST_MAJOR" ] 2>/dev/null; then
            echo "update_needed=true" >> $GITHUB_OUTPUT
            echo "Update needed (major)"
          elif [ "$CURRENT_MINOR" -gt "$LATEST_MINOR" ] 2>/dev/null; then
            echo "update_needed=false" >> $GITHUB_OUTPUT
            echo "Current version is newer (minor)"
          elif [ "$CURRENT_MINOR" -lt "$LATEST_MINOR" ] 2>/dev/null; then
            echo "update_needed=true" >> $GITHUB_OUTPUT
            echo "Update needed (minor)"
          elif [ "$CURRENT_PATCH" -lt "$LATEST_PATCH" ] 2>/dev/null; then
            echo "update_needed=true" >> $GITHUB_OUTPUT
            echo "Update needed (patch)"
          else
            echo "update_needed=false" >> $GITHUB_OUTPUT
            echo "Current version is up-to-date: v$LATEST"
          fi

      - name: Exit if up-to-date
        if: steps.compare-versions.outputs.update_needed != 'true'
        run: |
          echo "Current version is up-to-date: v${{ steps.current-version.outputs.version }}"
          echo "No action needed"

      - name: Check for existing PRs
        id: check-existing-prs
        if: steps.compare-versions.outputs.update_needed == 'true'
        run: |
          LATEST="${{ steps.latest-version.outputs.version }}"
          echo "Checking for existing PRs with version $LATEST"

          # Search for existing PRs with crush-update label
          EXISTING_PR=$(gh pr list \
            --label crush-update \
            --state all \
            --json title,number \
            --jq '.[] | select(.title == "Update Crush CLI to v'$LATEST'") | "\(.number) \(.title)"' || echo "")

          if [ -n "$EXISTING_PR" ]; then
            echo "existing_pr=true" >> $GITHUB_OUTPUT
            echo "Existing PR found: $EXISTING_PR"
            echo "Skipping PR creation"
          else
            echo "existing_pr=false" >> $GITHUB_OUTPUT
            echo "No existing PR found for version $LATEST"
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Exit if PR already exists
        if: steps.check-existing-prs.outputs.existing_pr == 'true'
        run: |
          LATEST="${{ steps.latest-version.outputs.version }}"
          echo "PR for version v$LATEST already exists"
          echo "Skipping branch and PR creation"

      - name: Create or checkout update branch
        id: branch
        if: |
          steps.compare-versions.outputs.update_needed == 'true' &&
          steps.check-existing-prs.outputs.existing_pr != 'true'
        run: |
          VERSION="${{ steps.latest-version.outputs.version }}"
          BRANCH_NAME="update/crush-v$VERSION"
          echo "name=$BRANCH_NAME" >> $GITHUB_OUTPUT

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git ls-remote --exit-code --heads origin "$BRANCH_NAME" >/dev/null 2>&1; then
            echo "Branch exists on origin: $BRANCH_NAME"
            git fetch origin "$BRANCH_NAME":"$BRANCH_NAME"
            git checkout "$BRANCH_NAME"
          else
            echo "Branch does not exist on origin, creating: $BRANCH_NAME"
            git checkout -b "$BRANCH_NAME"
          fi
      - name: Update CRUSH_VERSION in script
        if: |
          steps.compare-versions.outputs.update_needed == 'true' &&
          steps.check-existing-prs.outputs.existing_pr != 'true'
        run: |
          VERSION="${{ steps.latest-version.outputs.version }}"

          echo "Before:"
          grep -nE 'CRUSH_VERSION' docker-sandbox-crush || true

          # Replace CRUSH_VERSION line (handles optional "export " and leading whitespace)
          sed -i -E 's/^([[:space:]]*(export[[:space:]]+)?)CRUSH_VERSION=.*/\1CRUSH_VERSION="'"$VERSION"'"/' docker-sandbox-crush

          echo "After:"
          grep -nE 'CRUSH_VERSION' docker-sandbox-crush || true

          echo "Git diff:"
          git diff -- docker-sandbox-crush || true

      - name: Commit changes
        if: |
          steps.compare-versions.outputs.update_needed == 'true' &&
          steps.check-existing-prs.outputs.existing_pr != 'true'
        run: |
          VERSION="${{ steps.latest-version.outputs.version }}"
          git add docker-sandbox-crush
          if git diff --cached --quiet; then
           echo "No changes to commit"
           exit 0
          fi
          git commit -m "fix: update Crush CLI to v$VERSION"

      - name: Push branch
        if: |
          steps.compare-versions.outputs.update_needed == 'true' &&
          steps.check-existing-prs.outputs.existing_pr != 'true'
        run: |
          BRANCH_NAME="${{ steps.branch.outputs.name }}"
          git push --set-upstream origin "$BRANCH_NAME"

      - name: Create pull request
        if: |
          steps.compare-versions.outputs.update_needed == 'true' &&
          steps.check-existing-prs.outputs.existing_pr != 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ steps.branch.outputs.name }}
          title: "Update Crush CLI to v${{ steps.latest-version.outputs.version }}"
          body: "## Update Crush CLI to v${{ steps.latest-version.outputs.version }}"
          labels: crush-update
          commit-message: "fix: update Crush CLI to v${{ steps.latest-version.outputs.version }}"
          base: main
