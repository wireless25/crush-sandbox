name: Check Crush Updates

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-crush-updates:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest Crush version from npm
        id: latest-version
        run: |
          LATEST_VERSION=$(npm view @charmland/crush version)
          echo "version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "Latest @charmland/crush version: $LATEST_VERSION"

      - name: Parse current CRUSH_VERSION from script
        id: current-version
        run: |
          CURRENT_VERSION=$(grep '^CRUSH_VERSION=' docker-sandbox-crush | cut -d'"' -f2)
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current Crush version: $CURRENT_VERSION"

      - name: Compare versions
        id: compare-versions
        run: |
          CURRENT="${{ steps.current-version.outputs.version }}"
          LATEST="${{ steps.latest-version.outputs.version }}"

          echo "Comparing: $CURRENT vs $LATEST"

          # Parse version numbers
          IFS='.' read -r CURRENT_MAJOR CURRENT_MINOR CURRENT_PATCH <<< "$CURRENT"
          IFS='.' read -r LATEST_MAJOR LATEST_MINOR LATEST_PATCH <<< "$LATEST"

          # Remove 'v' prefix if present
          CURRENT_MAJOR="${CURRENT_MAJOR#v}"
          LATEST_MAJOR="${LATEST_MAJOR#v}"

          echo "Current: $CURRENT_MAJOR.$CURRENT_MINOR.$CURRENT_PATCH"
          echo "Latest: $LATEST_MAJOR.$LATEST_MINOR.$LATEST_PATCH"

          # Compare versions
          if [ "$CURRENT_MAJOR" -gt "$LATEST_MAJOR" ] 2>/dev/null; then
            echo "update_needed=false" >> $GITHUB_OUTPUT
            echo "Current version is newer (major)"
          elif [ "$CURRENT_MAJOR" -lt "$LATEST_MAJOR" ] 2>/dev/null; then
            echo "update_needed=true" >> $GITHUB_OUTPUT
            echo "Update needed (major)"
          elif [ "$CURRENT_MINOR" -gt "$LATEST_MINOR" ] 2>/dev/null; then
            echo "update_needed=false" >> $GITHUB_OUTPUT
            echo "Current version is newer (minor)"
          elif [ "$CURRENT_MINOR" -lt "$LATEST_MINOR" ] 2>/dev/null; then
            echo "update_needed=true" >> $GITHUB_OUTPUT
            echo "Update needed (minor)"
          elif [ "$CURRENT_PATCH" -lt "$LATEST_PATCH" ] 2>/dev/null; then
            echo "update_needed=true" >> $GITHUB_OUTPUT
            echo "Update needed (patch)"
          else
            echo "update_needed=false" >> $GITHUB_OUTPUT
            echo "Current version is up-to-date: v$LATEST"
          fi

      - name: Exit if up-to-date
        if: steps.compare-versions.outputs.update_needed != 'true'
        run: |
          echo "Current version is up-to-date: v${{ steps.current-version.outputs.version }}"
          echo "No action needed"

      - name: Check for existing PRs
        id: check-existing-prs
        if: steps.compare-versions.outputs.update_needed == 'true'
        run: |
          LATEST="${{ steps.latest-version.outputs.version }}"
          echo "Checking for existing PRs with version $LATEST"

          # Search for existing PRs with crush-update label
          EXISTING_PR=$(gh pr list \
            --label crush-update \
            --state all \
            --json title,number \
            --jq '.[] | select(.title == "Update Crush CLI to v'$LATEST'") | "\(.number) \(.title)"' || echo "")

          if [ -n "$EXISTING_PR" ]; then
            echo "existing_pr=true" >> $GITHUB_OUTPUT
            echo "Existing PR found: $EXISTING_PR"
            echo "Skipping PR creation"
          else
            echo "existing_pr=false" >> $GITHUB_OUTPUT
            echo "No existing PR found for version $LATEST"
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Exit if PR already exists
        if: steps.check-existing-prs.outputs.existing_pr == 'true'
        run: |
          LATEST="${{ steps.latest-version.outputs.version }}"
          echo "PR for version v$LATEST already exists"
          echo "Skipping branch and PR creation"

      - name: Create update branch
        if: |
          steps.compare-versions.outputs.update_needed == 'true' &&
          steps.check-existing-prs.outputs.existing_pr != 'true'
        run: |
          VERSION="${{ steps.latest-version.outputs.version }}"
          BRANCH_NAME="update/crush-v$VERSION"

          echo "Checking for existing branch: $BRANCH_NAME"

          # Check if branch exists
          if git show-ref --verify --quiet "refs/remotes/origin/$BRANCH_NAME" 2>/dev/null; then
            echo "Branch $BRANCH_NAME already exists, checking it out"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git checkout "$BRANCH_NAME"
            git pull origin "$BRANCH_NAME"
          else
            echo "Creating new branch: $BRANCH_NAME"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git checkout -b "$BRANCH_NAME"
          fi

      - name: Update CRUSH_VERSION in script
        if: |
          steps.compare-versions.outputs.update_needed == 'true' &&
          steps.check-existing-prs.outputs.existing_pr != 'true'
        run: |
          VERSION="${{ steps.latest-version.outputs.version }}"
          sed -i "s/^CRUSH_VERSION=.*/CRUSH_VERSION=\"$VERSION\"/" docker-sandbox-crush
          echo "Updated CRUSH_VERSION to $VERSION"

      - name: Commit changes
        if: |
          steps.compare-versions.outputs.update_needed == 'true' &&
          steps.check-existing-prs.outputs.existing_pr != 'true'
        run: |
          VERSION="${{ steps.latest-version.outputs.version }}"
          git add docker-sandbox-crush

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit, CRUSH_VERSION already at $VERSION"
          else
            git commit -m "fix: update Crush CLI to v$VERSION"
            echo "Changes committed"
          fi

      - name: Push branch
        if: |
          steps.compare-versions.outputs.update_needed == 'true' &&
          steps.check-existing-prs.outputs.existing_pr != 'true'
        run: |
          VERSION="${{ steps.latest-version.outputs.version }}"
          BRANCH_NAME="update/crush-v$VERSION"

          # Only push if we have new commits
          if [ "$(git rev-parse HEAD)" != "$(git rev-parse origin/$BRANCH_NAME 2>/dev/null)" ] || ! git show-ref --verify --quiet "refs/remotes/origin/$BRANCH_NAME"; then
            git push -u origin "$BRANCH_NAME"
            echo "Branch pushed successfully"
          else
            echo "Branch already up-to-date, skipping push"
          fi

      - name: Create pull request
        if: |
          steps.compare-versions.outputs.update_needed == 'true' &&
          steps.check-existing-prs.outputs.existing_pr != 'true'
        run: |
          VERSION="${{ steps.latest-version.outputs.version }}"
          BRANCH_NAME="update/crush-v$VERSION"
          CURRENT="${{ steps.current-version.outputs.version }}"

          # Use personal access token if provided, otherwise use default token
          TOKEN="${{ secrets.CRUSH_UPDATE_TOKEN }}"
          if [ -z "$TOKEN" ]; then
            TOKEN="${{ github.token }}"
            echo "Warning: Using default GitHub token. PR creation may fail due to permissions."
            echo "Consider setting CRUSH_UPDATE_TOKEN secret with a Personal Access Token."
          fi

          # Check if PR already exists
          if gh pr view "$BRANCH_NAME" --json title --jq '.title' 2>/dev/null | grep -q "Update Crush CLI to v$VERSION"; then
            echo "PR already exists for version v$VERSION, skipping"
            exit 0
          fi

          # Create PR
          gh pr create \
            --title "Update Crush CLI to v$VERSION" \
            --body "## Update Crush CLI to v$VERSION

          This PR updates the Crush CLI version from v$CURRENT to v$VERSION.

          ### Testing Instructions

          1. Review the changes to \`docker-sandbox-crush\`
          2. Test the updated script locally:
             \`\`\`bash
             ./docker-sandbox-crush clean --force
             ./docker-sandbox-crush run
             \`\`\`
          3. Verify Crush CLI works correctly inside the container
          4. Check that the correct version is installed

          ### Automated

          This PR was automatically created by the Crush Version Update CI workflow." \
            --base main \
            --label crush-update \
            --reviewer wireless25 || {
            echo "Failed to create PR. This is expected if using the default GitHub token."
            echo "Branch $BRANCH_NAME has been created and pushed."
            echo "Please create the PR manually or set CRUSH_UPDATE_TOKEN secret."
            exit 0
          }
        env:
          GH_TOKEN: ${{ secrets.CRUSH_UPDATE_TOKEN != '' && secrets.CRUSH_UPDATE_TOKEN || github.token }}
          GITHUB_TOKEN: ${{ secrets.CRUSH_UPDATE_TOKEN != '' && secrets.CRUSH_UPDATE_TOKEN || github.token }}
